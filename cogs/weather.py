import discord
from discord import app_commands
from discord.ext import commands
import requests
import os
import sqlite3
from datetime import datetime

class Weather(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.location_data = {
            "ì„œìš¸": {
                "ì¢…ë¡œêµ¬": (60, 127), "ì¤‘êµ¬": (60, 127), "ìš©ì‚°êµ¬": (60, 126), "ì„±ë™êµ¬": (61, 126), "ê´‘ì§„êµ¬": (62, 126),
                "ë™ëŒ€ë¬¸êµ¬": (61, 127), "ì¤‘ë‘êµ¬": (62, 128), "ì„±ë¶êµ¬": (61, 127), "ê°•ë¶êµ¬": (61, 128), "ë„ë´‰êµ¬": (61, 129),
                "ë…¸ì›êµ¬": (61, 129), "ì€í‰êµ¬": (59, 127), "ì„œëŒ€ë¬¸êµ¬": (59, 127), "ë§ˆí¬êµ¬": (59, 127), "ì–‘ì²œêµ¬": (58, 126),
                "ê°•ì„œêµ¬": (58, 126), "êµ¬ë¡œêµ¬": (58, 125), "ê¸ˆì²œêµ¬": (59, 124), "ì˜ë“±í¬êµ¬": (58, 126), "ë™ì‘êµ¬": (59, 125),
                "ê´€ì•…êµ¬": (59, 125), "ì„œì´ˆêµ¬": (61, 125), "ê°•ë‚¨êµ¬": (61, 126), "ì†¡íŒŒêµ¬": (62, 126), "ê°•ë™êµ¬": (62, 126)
            },
            "ë¶€ì‚°": {
                "ì¤‘êµ¬": (97, 74), "ì„œêµ¬": (97, 74), "ë™êµ¬": (98, 75), "ì˜ë„êµ¬": (98, 74), "ë¶€ì‚°ì§„êµ¬": (97, 74),
                "ë™ë˜êµ¬": (98, 76), "ë‚¨êµ¬": (98, 75), "ë¶êµ¬": (96, 76), "í•´ìš´ëŒ€êµ¬": (99, 75), "ì‚¬í•˜êµ¬": (96, 74),
                "ê¸ˆì •êµ¬": (98, 77), "ê°•ì„œêµ¬": (96, 76), "ì—°ì œêµ¬": (98, 76), "ìˆ˜ì˜êµ¬": (99, 75), "ì‚¬ìƒêµ¬": (96, 75),
                "ê¸°ì¥êµ°": (100, 77)
            },
            "ëŒ€êµ¬": {
                "ì¤‘êµ¬": (89, 90), "ë™êµ¬": (90, 91), "ì„œêµ¬": (88, 90), "ë‚¨êµ¬": (89, 90), "ë¶êµ¬": (89, 91),
                "ìˆ˜ì„±êµ¬": (89, 90), "ë‹¬ì„œêµ¬": (88, 90), "ë‹¬ì„±êµ°": (86, 88), "êµ°ìœ„êµ°": (88, 99)
            },
            "ì¸ì²œ": {
                "ì¤‘êµ¬": (54, 125), "ë™êµ¬": (54, 125), "ë¯¸ì¶”í™€êµ¬": (54, 124), "ì—°ìˆ˜êµ¬": (55, 124), "ë‚¨ë™êµ¬": (56, 124),
                "ë¶€í‰êµ¬": (55, 125), "ê³„ì–‘êµ¬": (56, 126), "ì„œêµ¬": (54, 126), "ê°•í™”êµ°": (51, 130), "ì˜¹ì§„êµ°": (54, 124)
            },
            "ê´‘ì£¼": {
                "ë™êµ¬": (59, 74), "ì„œêµ¬": (58, 74), "ë‚¨êµ¬": (58, 74), "ë¶êµ¬": (58, 74), "ê´‘ì‚°êµ¬": (57, 74)
            },
            "ëŒ€ì „": {
                "ë™êµ¬": (68, 100), "ì¤‘êµ¬": (68, 100), "ì„œêµ¬": (67, 100), "ìœ ì„±êµ¬": (67, 101), "ëŒ€ë•êµ¬": (68, 100)
            },
            "ìš¸ì‚°": {
                "ì¤‘êµ¬": (102, 84), "ë‚¨êµ¬": (102, 84), "ë™êµ¬": (104, 84), "ë¶êµ¬": (103, 85), "ìš¸ì£¼êµ°": (101, 84)
            },
            "ì„¸ì¢…": {
                "ì„¸ì¢…ì‹œ": (66, 103)
            },
            "ê²½ê¸°ë¶ë¶€": {
                "ì˜ì •ë¶€ì‹œ": (61, 130), "ë™ë‘ì²œì‹œ": (61, 132), "êµ¬ë¦¬ì‹œ": (62, 127), "ë‚¨ì–‘ì£¼ì‹œ": (62, 128), "ì–‘ì£¼ì‹œ": (61, 131),
                "í¬ì²œì‹œ": (64, 134), "ì—°ì²œêµ°": (61, 134), "ê°€í‰êµ°": (69, 133),
                "ê³ ì–‘ì‹œë•ì–‘êµ¬": (57, 128), "ê³ ì–‘ì‹œì¼ì‚°ë™êµ¬": (56, 129), "ê³ ì–‘ì‹œì¼ì‚°ì„œêµ¬": (56, 129),
                "íŒŒì£¼ì‹œ": (56, 131)
            },
            "ê²½ê¸°ë‚¨ë¶€": {
                "ìˆ˜ì›ì‹œì¥ì•ˆêµ¬": (60, 122), "ìˆ˜ì›ì‹œê¶Œì„ êµ¬": (60, 120), "ìˆ˜ì›ì‹œíŒ”ë‹¬êµ¬": (61, 121), "ìˆ˜ì›ì‹œì˜í†µêµ¬": (61, 120),
                "ì„±ë‚¨ì‹œìˆ˜ì •êµ¬": (63, 124), "ì„±ë‚¨ì‹œì¤‘ì›êµ¬": (63, 124), "ì„±ë‚¨ì‹œë¶„ë‹¹êµ¬": (62, 123),
                "ì˜ì™•ì‹œ": (60, 122), "ì•ˆì–‘ì‹œë§Œì•ˆêµ¬": (59, 123), "ì•ˆì–‘ì‹œë™ì•ˆêµ¬": (59, 123),
                "ë¶€ì²œì‹œ": (57, 125), "ê´‘ëª…ì‹œ": (58, 125), "í‰íƒì‹œ": (62, 114),
                "ì•ˆì‚°ì‹œìƒë¡êµ¬": (58, 121), "ì•ˆì‚°ì‹œë‹¨ì›êµ¬": (58, 120), "ê³¼ì²œì‹œ": (60, 124),
                "êµ¬ë¦¬ì‹œ": (62, 127), "ì˜¤ì‚°ì‹œ": (62, 118), "ì‹œí¥ì‹œ": (57, 121), "êµ°í¬ì‹œ": (59, 122),
                "í•˜ë‚¨ì‹œ": (64, 126), "ìš©ì¸ì‹œì²˜ì¸êµ¬": (64, 119), "ìš©ì¸ì‹œê¸°í¥êµ¬": (62, 120), "ìš©ì¸ì‹œìˆ˜ì§€êµ¬": (60, 122),
                "ì´ì²œì‹œ": (68, 121), "ì•ˆì„±ì‹œ": (65, 115), "ê¹€í¬ì‹œ": (55, 128), "í™”ì„±ì‹œ": (57, 121),
                "ê´‘ì£¼ì‹œ": (65, 123), "ì–‘í‰êµ°": (69, 125), "ì—¬ì£¼ì‹œ": (71, 121)
            },
            "ê°•ì›": {
                "ì¶˜ì²œì‹œ": (73, 134), "ì›ì£¼ì‹œ": (76, 122), "ê°•ë¦‰ì‹œ": (92, 131), "ë™í•´ì‹œ": (97, 127), "íƒœë°±ì‹œ": (95, 119),
                "ì†ì´ˆì‹œ": (87, 141), "ì‚¼ì²™ì‹œ": (98, 125), "í™ì²œêµ°": (75, 130), "íš¡ì„±êµ°": (77, 125), "ì˜ì›”êµ°": (86, 119),
                "í‰ì°½êµ°": (84, 127), "ì •ì„ êµ°": (89, 123), "ì² ì›êµ°": (65, 139), "í™”ì²œêµ°": (72, 139), "ì–‘êµ¬êµ°": (80, 139),
                "ì¸ì œêµ°": (80, 138), "ê³ ì„±êµ°": (85, 145), "ì–‘ì–‘êµ°": (88, 138)
            },
            "ì¶©ë¶": {
                "ì²­ì£¼ì‹œìƒë‹¹êµ¬": (69, 106), "ì²­ì£¼ì‹œì„œì›êµ¬": (69, 107), "ì²­ì£¼ì‹œí¥ë•êµ¬": (68, 106), "ì²­ì£¼ì‹œì²­ì›êµ¬": (69, 107),
                "ì¶©ì£¼ì‹œ": (76, 114), "ì œì²œì‹œ": (81, 118), "ë³´ì€êµ°": (73, 103), "ì˜¥ì²œêµ°": (71, 99), "ì˜ë™êµ°": (74, 91),
                "ì¦í‰êµ°": (69, 110), "ì§„ì²œêµ°": (68, 111), "ê´´ì‚°êµ°": (74, 111), "ìŒì„±êµ°": (72, 113), "ë‹¨ì–‘êµ°": (84, 115)
            },
            "ì¶©ë‚¨": {
                "ì²œì•ˆì‹œë™ë‚¨êµ¬": (63, 110), "ì²œì•ˆì‹œì„œë¶êµ¬": (63, 110), "ê³µì£¼ì‹œ": (63, 102), "ë³´ë ¹ì‹œ": (54, 100), "ì•„ì‚°ì‹œ": (60, 110),
                "ì„œì‚°ì‹œ": (51, 110), "ë…¼ì‚°ì‹œ": (62, 99), "ê³„ë£¡ì‹œ": (65, 99), "ë‹¹ì§„ì‹œ": (54, 112), "ê¸ˆì‚°êµ°": (69, 95),
                "ë¶€ì—¬êµ°": (59, 94), "ì„œì²œêµ°": (55, 92), "ì²­ì–‘êµ°": (57, 99), "í™ì„±êµ°": (55, 106), "ì˜ˆì‚°êµ°": (58, 107),
                "íƒœì•ˆêµ°": (48, 109)
            },
            "ì „ë¶": {
                "ì „ì£¼ì‹œì™„ì‚°êµ¬": (63, 89), "ì „ì£¼ì‹œë•ì§„êµ¬": (63, 89), "êµ°ì‚°ì‹œ": (56, 92), "ìµì‚°ì‹œ": (60, 91), "ì •ìì‹œ": (58, 83),
                "ë‚¨ì›ì‹œ": (68, 80), "ê¹€ì œì‹œ": (59, 88), "ì™„ì£¼êµ°": (63, 89), "ì§„ì•ˆêµ°": (68, 88), "ë¬´ì£¼êµ°": (72, 93),
                "ì¥ìˆ˜êµ°": (70, 85), "ì„ì‹¤êµ°": (66, 84), "ìˆœì°½êµ°": (63, 79), "ê³ ì°½êµ°": (56, 80), "ë¶€ì•ˆêµ°": (56, 87)
            },
            "ì „ë‚¨": {
                "ëª©í¬ì‹œ": (50, 67), "ì—¬ìˆ˜ì‹œ": (73, 66), "ìˆœì²œì‹œ": (70, 70), "ë‚˜ì£¼ì‹œ": (56, 71), "ê´‘ì–‘ì‹œ": (73, 70),
                "ë‹´ì–‘êµ°": (61, 78), "ê³¡ì„±êµ°": (66, 77), "êµ¬ë¡€êµ°": (69, 75), "ê³ í¥êµ°": (67, 62), "ë³´ì„±êµ°": (62, 66),
                "í™”ìˆœêµ°": (61, 72), "ì¥í¥êµ°": (59, 64), "ê°•ì§„êµ°": (57, 63), "í•´ë‚¨êµ°": (54, 61), "ì˜ì•”êµ°": (56, 66),
                "ë¬´ì•ˆêµ°": (52, 71), "í•¨í‰êµ°": (52, 72), "ì˜ê´‘êµ°": (52, 77), "ì¥ì„±êµ°": (57, 77), "ì™„ë„êµ°": (57, 56),
                "ì§„ë„êµ°": (48, 59), "ì‹ ì•ˆêµ°": (50, 66)
            },
            "ê²½ë¶": {
                "í¬í•­ì‹œë‚¨êµ¬": (102, 94), "í¬í•­ì‹œë¶êµ¬": (102, 94), "ê²½ì£¼ì‹œ": (100, 91), "ê¹€ì²œì‹œ": (80, 96), "ì•ˆë™ì‹œ": (91, 106),
                "êµ¬ë¯¸ì‹œ": (84, 96), "ì˜ì£¼ì‹œ": (89, 111), "ì˜ì²œì‹œ": (95, 93), "ìƒì£¼ì‹œ": (81, 102), "ë¬¸ê²½ì‹œ": (78, 110),
                "ê²½ì‚°ì‹œ": (91, 90), "ì˜ì„±êµ°": (90, 101), "ì²­ì†¡êµ°": (99, 103), "ì˜ì–‘êµ°": (97, 108), "ì˜ë•êµ°": (102, 103),
                "ì²­ë„êµ°": (91, 86), "ê³ ë ¹êµ°": (83, 87), "ì„±ì£¼êµ°": (83, 91), "ì¹ ê³¡êµ°": (85, 93), "ì˜ˆì²œêµ°": (86, 107),
                "ë´‰í™”êµ°": (90, 113), "ìš¸ì§„êµ°": (102, 115), "ìš¸ë¦‰êµ°": (127, 127)
            },
            "ê²½ë‚¨": {
                "ì°½ì›ì‹œì˜ì°½êµ¬": (90, 77), "ì°½ì›ì‹œì„±ì‚°êµ¬": (91, 77), "ì°½ì›ì‹œë§ˆì‚°í•©í¬êµ¬": (89, 76), "ì°½ì›ì‹œë§ˆì‚°íšŒì›êµ¬": (89, 76), "ì°½ì›ì‹œì§„í•´êµ¬": (91, 75),
                "ì§„ì£¼ì‹œ": (81, 75), "í†µì˜ì‹œ": (87, 68), "ì‚¬ì²œì‹œ": (78, 73), "ê¹€í•´ì‹œ": (95, 77), "ë°€ì–‘ì‹œ": (94, 83),
                "ê±°ì œì‹œ": (90, 69), "ì–‘ì‚°ì‹œ": (97, 79), "ì˜ë ¹êµ°": (83, 78), "í•¨ì•ˆêµ°": (86, 77), "ì°½ë…•êµ°": (87, 84),
                "ê³ ì„±êµ°": (85, 71), "ë‚¨í•´êµ°": (77, 68), "í•˜ë™êµ°": (74, 73), "ì‚°ì²­êµ°": (76, 80), "í•¨ì–‘êµ°": (74, 82),
                "ê±°ì°½êµ°": (77, 86), "í•©ì²œêµ°": (81, 84)
            },
            "ì œì£¼": {
                "ì œì£¼ì‹œ": (52, 38), "ì„œê·€í¬ì‹œ": (52, 33)
            }
        }

    async def check_membership(self, interaction: discord.Interaction):
        db = sqlite3.connect('data.db')
        cur = db.cursor()
        cur.execute("SELECT agreed FROM terms WHERE user_id = ?", (interaction.user.id,))
        result = cur.fetchone()
        db.close()
        
        if not result or result[0] != 1:
            embed = discord.Embed(
                title="â›” ê¶Œí•œ ì—†ìŒ", 
                description="ë¹„íŠ¸ì˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € `/ì„œë¹„ìŠ¤ê°€ì…`ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.", 
                color=0xFF0000
            )
            await interaction.response.send_message(embed=embed, ephemeral=True)
            return False
        return True

    def get_pty_status(self, value):
        pty_dict = {'0': "ì—†ìŒ", '1': "ë¹„", '2': "ë¹„/ëˆˆ", '3': "ëˆˆ", '5': "ë¹—ë°©ìš¸", '6': "ë¹—ë°©ìš¸/ëˆˆë‚ ë¦¼", '7': "ëˆˆë‚ ë¦¼"}
        return pty_dict.get(value, "ì •ë³´ ì—†ìŒ")

    async def city_autocomplete(self, interaction: discord.Interaction, current: str):
        state = interaction.namespace.ë„_ê´‘ì—­ì‹œ
        
        if not state or state not in self.location_data:
            return []
    
        return [
            app_commands.Choice(name=city, value=city)
            for city in self.location_data[state].keys() if current.lower() in city.lower()
        ][:25]
    
    @app_commands.command(name="ë‚ ì”¨", description="ì „êµ­ ëª¨ë“  ì‹œ/êµ°/êµ¬ì˜ í˜„ì¬ ë‚ ì”¨ ì‹¤í™©ì„ ì¡°íšŒí•©ë‹ˆë‹¤.")
    @app_commands.describe(ë„_ê´‘ì—­ì‹œ="ì§€ì—­(ë„/ê´‘ì—­ì‹œ)ì„ ì„ íƒí•˜ì„¸ìš”", ì‹œ_êµ°_êµ¬="ìƒì„¸ í–‰ì •êµ¬ì—­(ì‹œ/êµ°/êµ¬)ì„ ì„ íƒí•˜ì„¸ìš”")
    @app_commands.choices(ë„_ê´‘ì—­ì‹œ=[
        app_commands.Choice(name=k, value=k) for k in [
            "ì„œìš¸", "ê²½ê¸°ë¶ë¶€", "ê²½ê¸°ë‚¨ë¶€", "ì¸ì²œ", "ê°•ì›", "ì¶©ë¶", "ì¶©ë‚¨", "ì „ë¶", "ì „ë‚¨", "ê²½ë¶", "ê²½ë‚¨", "ë¶€ì‚°", "ëŒ€êµ¬", "ëŒ€ì „", "ê´‘ì£¼", "ìš¸ì‚°", "ì„¸ì¢…", "ì œì£¼"
        ]
    ])
    @app_commands.autocomplete(ì‹œ_êµ°_êµ¬=city_autocomplete)
    async def get_weather(self, interaction: discord.Interaction, ë„_ê´‘ì—­ì‹œ: str, ì‹œ_êµ°_êµ¬: str):
        if not await self.check_membership(interaction):
            return

        if ì‹œ_êµ°_êµ¬ not in self.location_data[ë„_ê´‘ì—­ì‹œ]:
            return await interaction.response.send_message("ëª©ë¡ì— ìˆëŠ” ìƒì„¸ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", ephemeral=True)
        nx, ny = self.location_data[ë„_ê´‘ì—­ì‹œ][ì‹œ_êµ°_êµ¬]
        from datetime import datetime, timedelta 
        
        now = datetime.now()
        request_time = now - timedelta(minutes=45)
        
        base_date = request_time.strftime("%Y%m%d")
        base_time = request_time.strftime("%H00")

        url = "http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst"
        params = {
            'serviceKey': os.getenv('WEATHER_API_KEY'),
            'pageNo': '1',
            'numOfRows': '10',
            'dataType': 'JSON',
            'base_date': base_date,
            'base_time': base_time,
            'nx': str(nx),
            'ny': str(ny)
        }

        await interaction.response.defer()

        try:
            response = requests.get(url, params=params)
            res_data = response.json()

            if res_data['response']['header']['resultCode'] == '00':
                items = res_data['response']['body']['items']['item']
                formatted_time = now.strftime("%Yë…„ %mì›” %dì¼ %Hì‹œ 00ë¶„")
                
                embed = discord.Embed(
                    title=f"ğŸŒ¤ï¸ {ë„_ê´‘ì—­ì‹œ} {ì‹œ_êµ°_êµ¬} ë‚ ì”¨ ë¦¬í¬íŠ¸",
                    description=f"**ë°œí‘œ ê¸°ì¤€:** {formatted_time}",
                    color=0x3498db
                )

                for item in items:
                    cat = item['category']
                    val = item['obsrValue']
                    
                    if cat == 'T1H': embed.add_field(name="ğŸŒ¡ï¸ ê¸°ì˜¨", value=f"**{val}Â°C**", inline=True)
                    elif cat == 'REH': embed.add_field(name="ğŸ’§ ìŠµë„", value=f"{val}%", inline=True)
                    elif cat == 'PTY': embed.add_field(name="ğŸŒ‚ ê°•ìˆ˜ í˜•íƒœ", value=self.get_pty_status(val), inline=True)
                    elif cat == 'RN1': embed.add_field(name="ğŸŒ§ï¸ ê°•ìˆ˜ëŸ‰(1h)", value=f"{val}mm", inline=True)
                    elif cat == 'WSD': embed.add_field(name="ğŸ’¨ í’ì†", value=f"{val}m/s", inline=True)

                embed.set_thumbnail(url="https://cdn-icons-png.flaticon.com/512/4814/4814268.png")
                embed.set_footer(text=f"ìš”ì²­ì: {interaction.user.display_name} | ë°ì´í„°: ê¸°ìƒì²­", icon_url=interaction.user.display_avatar.url)
                
                await interaction.followup.send(embed=embed)
            else:
                error_msg = res_data['response']['header']['resultMsg']
                await interaction.followup.send(f"âš ï¸ API ì˜¤ë¥˜: {error_msg}")

        except Exception as e:
            await interaction.followup.send(f"âŒ ë°ì´í„° í˜¸ì¶œ ì‹¤íŒ¨: {e}")

async def setup(bot):
    await bot.add_cog(Weather(bot))